# C√≥mo Crear la Apple Watch App para StadiumConnect Pro

## üéØ Objetivo
Crear una aplicaci√≥n companion para Apple Watch que permita:
1. **Detecci√≥n autom√°tica de emergencias** (ca√≠das, heart rate anormal)
2. **Bot√≥n SOS r√°pido** desde la mu√±eca
3. **Notificaciones de emergencias familiares**
4. **Navegaci√≥n h√°ptica b√°sica** hacia familiares

---

## üì± Paso a Paso: Agregar Target watchOS

### M√©todo 1: Usando Xcode GUI (RECOMENDADO)

#### 1. Abrir el Proyecto
```bash
open MeshRed.xcodeproj
```

#### 2. Agregar watchOS Target
1. En Xcode, ve a **File ‚Üí New ‚Üí Target**
2. Selecciona **watchOS** en la barra lateral izquierda
3. Elige **Watch App for iOS App**
4. Click **Next**

#### 3. Configurar el Target
- **Product Name**: `MeshRed Watch App`
- **Team**: QF2R75VM2Y (tu equipo actual)
- **Bundle Identifier**: `EmilioContreras.MeshRed.watchkitapp`
- **Language**: Swift
- **User Interface**: SwiftUI
- **Include Notification Scene**: ‚úÖ (S√≠, para notificaciones)
- **Host Application**: MeshRed (selecciona tu app iOS)

#### 4. Embed Watch App
- Xcode preguntar√° si quieres **Embed** la Watch App en tu app iOS
- Selecciona **Activate** (esto hace que el scheme watchOS est√© disponible)

---

## üìÅ Estructura de Archivos Creada

Despu√©s de crear el target, Xcode crear√°:

```
MeshRed/
‚îú‚îÄ‚îÄ MeshRed/                          # App iOS existente
‚îú‚îÄ‚îÄ MeshRed Watch App/                # Nueva carpeta Watch App
‚îÇ   ‚îú‚îÄ‚îÄ MeshRedWatchApp.swift        # Entry point watchOS
‚îÇ   ‚îú‚îÄ‚îÄ ContentView.swift            # Vista principal Watch
‚îÇ   ‚îú‚îÄ‚îÄ Assets.xcassets              # Recursos Watch
‚îÇ   ‚îî‚îÄ‚îÄ Preview Content/
‚îú‚îÄ‚îÄ MeshRed Watch App Extension/     # (Opcional, solo si usas WatchKit)
‚îî‚îÄ‚îÄ MeshRed.xcodeproj
```

---

## üîß Configuraci√≥n Manual Adicional

### 1. Compartir C√≥digo entre iOS y watchOS

Para compartir modelos y servicios, necesitas agregar archivos al target watchOS:

1. Selecciona los archivos que quieres compartir (ej: `SOSType.swift`, `FamilyGroup.swift`)
2. En **File Inspector** (panel derecho), marca el checkbox **MeshRed Watch App**
3. Archivos a compartir:
   - `Models/SOSType.swift` ‚úÖ
   - `Models/FamilyGroup.swift` ‚úÖ
   - `Models/FamilyMember.swift` ‚úÖ
   - `Models/EmergencyMedicalProfile.swift` ‚úÖ (cuando lo creemos)
   - `Services/EmergencyDetectionService.swift` ‚úÖ (cuando lo creemos)
   - `Theme/Mundial2026Theme.swift` ‚úÖ

### 2. Configurar Capabilities para watchOS

En **Signing & Capabilities** del target watchOS:
1. **HealthKit** ‚úÖ
2. **Background Modes**:
   - Workout Processing ‚úÖ
   - Background Sensor Recording ‚úÖ
3. **Push Notifications** ‚úÖ (para alertas familiares)

### 3. Actualizar Info.plist de Watch App

```xml
<!-- MeshRed Watch App/Info.plist -->
<key>NSHealthShareUsageDescription</key>
<string>Monitorea tu ritmo card√≠aco para detectar emergencias autom√°ticamente</string>

<key>NSHealthUpdateUsageDescription</key>
<string>Necesitamos acceso a tu frecuencia card√≠aca para tu seguridad</string>

<key>WKSupportsAlwaysOnDisplay</key>
<true/>

<key>WKApplication</key>
<true/>
```

---

## üèóÔ∏è Estructura de la Watch App

### Archivos a Crear Manualmente

```
MeshRed Watch App/
‚îú‚îÄ‚îÄ MeshRedWatchApp.swift              # Entry point
‚îú‚îÄ‚îÄ Views/
‚îÇ   ‚îú‚îÄ‚îÄ WatchContentView.swift         # Dashboard principal
‚îÇ   ‚îú‚îÄ‚îÄ WatchSOSView.swift             # Bot√≥n SOS grande
‚îÇ   ‚îú‚îÄ‚îÄ WatchFamilyStatusView.swift    # Estado de familia
‚îÇ   ‚îú‚îÄ‚îÄ WatchEmergencyCountdownView.swift # Countdown auto-detecci√≥n
‚îÇ   ‚îî‚îÄ‚îÄ WatchNavigationView.swift      # Navegaci√≥n h√°ptica
‚îú‚îÄ‚îÄ Services/
‚îÇ   ‚îú‚îÄ‚îÄ WatchConnectivityManager.swift # Comunicaci√≥n iOS ‚Üî Watch
‚îÇ   ‚îî‚îÄ‚îÄ WatchEmergencyDetector.swift   # Detecci√≥n espec√≠fica Watch
‚îú‚îÄ‚îÄ Models/
‚îÇ   ‚îî‚îÄ‚îÄ (Compartidos con iOS)
‚îî‚îÄ‚îÄ Assets.xcassets/
    ‚îî‚îÄ‚îÄ ComplicationAssets/            # Para complications
```

---

## üîå Comunicaci√≥n iOS ‚Üî Watch

### Watch Connectivity Framework

La Watch App necesita comunicarse con la app iOS para:
- Enviar alertas SOS
- Recibir estado de familia
- Sincronizar configuraci√≥n

**WatchConnectivityManager.swift:**
```swift
import WatchConnectivity

class WatchConnectivityManager: NSObject, ObservableObject, WCSessionDelegate {
    static let shared = WatchConnectivityManager()

    private var session: WCSession?

    @Published var familyEmergencies: [FamilyEmergencyAlert] = []
    @Published var connectedPeersCount: Int = 0

    override init() {
        super.init()

        if WCSession.isSupported() {
            session = WCSession.default
            session?.delegate = self
            session?.activate()
        }
    }

    // Enviar SOS desde Watch ‚Üí iPhone
    func sendSOSAlert(_ alert: SOSAlert) {
        guard let session = session, session.isReachable else {
            LoggingService.network.info("‚ö†Ô∏è iPhone no alcanzable")
            return
        }

        let message = ["type": "sos", "alert": alert.encode()]
        session.sendMessage(message, replyHandler: nil)
    }

    // Delegates de WCSession
    func session(_ session: WCSession,
                 activationDidCompleteWith activationState: WCSessionActivationState,
                 error: Error?) {
        LoggingService.network.info("Watch session activated: \(activationState.rawValue)")
    }

    func session(_ session: WCSession,
                 didReceiveMessage message: [String : Any]) {
        // Recibir actualizaciones desde iPhone
        if let type = message["type"] as? String {
            switch type {
            case "familyEmergency":
                // Actualizar estado de emergencias familiares
                break
            case "networkStatus":
                // Actualizar estado de red mesh
                break
            default:
                break
            }
        }
    }
}
```

---

## üé® UI Espec√≠fica de Watch

### WatchSOSView.swift - Bot√≥n SOS Gigante

```swift
import SwiftUI
import WatchKit

struct WatchSOSView: View {
    @StateObject private var connectivity = WatchConnectivityManager.shared
    @State private var isPressed = false
    @State private var showCountdown = false

    var body: some View {
        ZStack {
            // Bot√≥n SOS que ocupa toda la pantalla
            Button(action: triggerSOS) {
                ZStack {
                    Circle()
                        .fill(Color.red)
                        .opacity(isPressed ? 0.8 : 1.0)

                    VStack(spacing: 4) {
                        Image(systemName: "sos.circle.fill")
                            .font(.system(size: 40))
                            .foregroundColor(.white)

                        Text("SOS")
                            .font(.title2.bold())
                            .foregroundColor(.white)
                    }
                }
            }
            .buttonStyle(.plain)
            .simultaneousGesture(
                DragGesture(minimumDistance: 0)
                    .onChanged { _ in isPressed = true }
                    .onEnded { _ in isPressed = false }
            )
        }
        .edgesIgnoringSafeArea(.all)
        .sheet(isPresented: $showCountdown) {
            WatchEmergencyCountdownView()
        }
    }

    private func triggerSOS() {
        // Haptic fuerte
        WKInterfaceDevice.current().play(.notification)

        showCountdown = true
    }
}
```

### WatchEmergencyCountdownView.swift

```swift
import SwiftUI
import WatchKit

struct WatchEmergencyCountdownView: View {
    @Environment(\.dismiss) var dismiss
    @StateObject private var connectivity = WatchConnectivityManager.shared

    @State private var countdown = 3
    @State private var timer: Timer?

    var body: some View {
        VStack(spacing: 12) {
            Text("Enviando SOS")
                .font(.headline)
                .foregroundColor(.red)

            // Countdown circular
            ZStack {
                Circle()
                    .stroke(Color.red.opacity(0.3), lineWidth: 8)
                    .frame(width: 80, height: 80)

                Text("\(countdown)")
                    .font(.system(size: 40, weight: .bold))
                    .foregroundColor(.red)
            }

            Button("CANCELAR") {
                cancelSOS()
            }
            .buttonStyle(.bordered)
            .tint(.red)
        }
        .onAppear {
            startCountdown()
        }
        .onDisappear {
            timer?.invalidate()
        }
    }

    private func startCountdown() {
        // Haptic cada segundo
        WKInterfaceDevice.current().play(.start)

        timer = Timer.scheduledTimer(withTimeInterval: 1.0, repeats: true) { _ in
            if countdown > 0 {
                countdown -= 1
                WKInterfaceDevice.current().play(.click)
            } else {
                sendSOS()
            }
        }
    }

    private func cancelSOS() {
        timer?.invalidate()
        dismiss()
    }

    private func sendSOS() {
        timer?.invalidate()

        // Crear alerta SOS
        let alert = SOSAlert(
            type: .emergenciaMedica,
            senderID: "Watch-User",
            senderName: "Apple Watch",
            location: nil,
            message: "Emergencia desde Apple Watch"
        )

        // Enviar a iPhone
        connectivity.sendSOSAlert(alert)

        // Haptic de confirmaci√≥n
        WKInterfaceDevice.current().play(.success)

        dismiss()
    }
}
```

---

## ‚åö Detecci√≥n de Emergencias en Watch

### Ventajas del Apple Watch:
1. **Heart Rate siempre activo** (m√°s preciso que iPhone)
2. **Detecci√≥n de ca√≠das nativa** (watchOS 4+)
3. **Acceler√≥metro de alta frecuencia**
4. **Siempre en la mu√±eca** (mejor para emergencias)

### WatchEmergencyDetector.swift

```swift
import HealthKit
import WatchKit

class WatchEmergencyDetector: NSObject, ObservableObject {
    private let healthStore = HKHealthStore()

    @Published var currentHeartRate: Double = 0
    @Published var emergencyDetected: Bool = false

    private var heartRateQuery: HKAnchoredObjectQuery?

    // Umbrales
    private let highHeartRateThreshold: Double = 150  // BPM
    private let lowHeartRateThreshold: Double = 40    // BPM

    func startMonitoring() {
        requestAuthorization()
        startHeartRateMonitoring()
    }

    private func requestAuthorization() {
        let heartRateType = HKObjectType.quantityType(forIdentifier: .heartRate)!

        healthStore.requestAuthorization(toShare: nil, read: [heartRateType]) { success, error in
            if success {
                LoggingService.network.info("‚úÖ HealthKit authorized on Watch")
            } else {
                LoggingService.network.info("‚ùå HealthKit authorization failed: \(error?.localizedDescription ?? "")")
            }
        }
    }

    private func startHeartRateMonitoring() {
        let heartRateType = HKObjectType.quantityType(forIdentifier: .heartRate)!

        let query = HKAnchoredObjectQuery(
            type: heartRateType,
            predicate: nil,
            anchor: nil,
            limit: HKObjectQueryNoLimit
        ) { [weak self] query, samples, deletedObjects, anchor, error in
            self?.processHeartRateSamples(samples)
        }

        query.updateHandler = { [weak self] query, samples, deletedObjects, anchor, error in
            self?.processHeartRateSamples(samples)
        }

        healthStore.execute(query)
        heartRateQuery = query
    }

    private func processHeartRateSamples(_ samples: [HKSample]?) {
        guard let heartRateSamples = samples as? [HKQuantitySample] else { return }

        for sample in heartRateSamples {
            let bpm = sample.quantity.doubleValue(for: HKUnit(from: "count/min"))

            DispatchQueue.main.async {
                self.currentHeartRate = bpm
                self.checkForAbnormalHeartRate(bpm)
            }
        }
    }

    private func checkForAbnormalHeartRate(_ bpm: Double) {
        if bpm > highHeartRateThreshold || bpm < lowHeartRateThreshold {
            LoggingService.network.info("‚ö†Ô∏è ABNORMAL HEART RATE: \(bpm) BPM")
            triggerEmergencyDetection()
        }
    }

    private func triggerEmergencyDetection() {
        emergencyDetected = true

        // Haptic de advertencia
        WKInterfaceDevice.current().play(.notification)
    }
}
```

---

## üöÄ Build y Testing

### 1. Seleccionar Scheme
En Xcode, cambia el scheme a **MeshRed Watch App**

### 2. Seleccionar Simulador
- iPhone 15 Pro + Apple Watch Series 9 (pareado)
- O dispositivo f√≠sico (requiere Apple Watch f√≠sico pareado)

### 3. Build y Run
```bash
# Desde terminal (opcional)
xcodebuild -scheme "MeshRed Watch App" \
  -destination "platform=watchOS Simulator,name=Apple Watch Series 9 (45mm)"
```

---

## üìã Checklist de Implementaci√≥n

### Configuraci√≥n Inicial:
- [ ] Crear target watchOS en Xcode
- [ ] Configurar Bundle IDs correctamente
- [ ] Agregar capabilities (HealthKit, Background Modes)
- [ ] Actualizar Info.plist con permisos

### C√≥digo Compartido:
- [ ] Marcar modelos como compartidos (SOSType, FamilyGroup)
- [ ] Crear WatchConnectivityManager
- [ ] Sincronizar configuraci√≥n entre iOS y Watch

### UI Watch:
- [ ] WatchContentView (dashboard)
- [ ] WatchSOSView (bot√≥n SOS)
- [ ] WatchEmergencyCountdownView (countdown)
- [ ] WatchFamilyStatusView (estado familia)

### Funcionalidad:
- [ ] Detecci√≥n de emergencias (heart rate)
- [ ] Env√≠o de SOS a iPhone
- [ ] Recepci√≥n de alertas familiares
- [ ] Haptic patterns espec√≠ficos

### Testing:
- [ ] Probar en simulador
- [ ] Probar en dispositivo real (ideal)
- [ ] Verificar comunicaci√≥n iPhone ‚Üî Watch
- [ ] Verificar HealthKit en Watch

---

## üéØ Prioridad de Funcionalidades Watch

### MVP (M√≠nimo Viable):
1. ‚úÖ Bot√≥n SOS gigante
2. ‚úÖ Countdown de 3 segundos
3. ‚úÖ Env√≠o a iPhone via WatchConnectivity
4. ‚úÖ Haptic feedback

### Fase 2:
1. ‚≠ê Heart rate monitoring
2. ‚≠ê Auto-detecci√≥n de emergencias
3. ‚≠ê Notificaciones de familia

### Fase 3:
1. üöÄ Navegaci√≥n h√°ptica b√°sica
2. üöÄ Complications (widget en car√°tula)
3. üöÄ Standalone mode (sin iPhone cerca)

---

## üí° Notas Importantes

### Limitaciones watchOS:
- **No MultipeerConnectivity**: Watch no puede hacer mesh networking directamente
- **Requiere iPhone cerca**: Para enviar mensajes a la red mesh
- **Bater√≠a limitada**: Monitoreo continuo consume bater√≠a r√°pido
- **Pantalla peque√±a**: UI debe ser MUY simple

### Ventajas watchOS:
- ‚úÖ **Siempre en la mu√±eca**: M√°s r√°pido que sacar iPhone
- ‚úÖ **HealthKit mejor**: Sensores de salud m√°s precisos
- ‚úÖ **Detecci√≥n de ca√≠das**: API nativa de Apple
- ‚úÖ **Haptics excelentes**: Taptic Engine muy preciso

---

## üîó Siguiente Paso

Despu√©s de crear el target watchOS, continuar con:
1. Implementar `EmergencyDetectionService.swift` (iOS)
2. Compartir ese c√≥digo con Watch target
3. Crear UI espec√≠fica de Watch
4. Integrar WatchConnectivity

¬øQuieres que proceda a crear el target manualmente o prefieres hacerlo desde Xcode GUI?
